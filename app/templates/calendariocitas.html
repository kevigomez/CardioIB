<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario y Registro de Citas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_calendario.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename='script/script.js') }}" defer></script>
</head>
<body>
    {% extends "base.html" %}
    {% block content %}
    <div class="Info_cita">
        <select class="cita">
            <option value="2">Cardiologia B</option>
            <option value="1">Cardiologia B</option>
            <option value="21" selected="selected">Cardiologia C</option>
            <option value="22">ECOCARDIOGRAMA TRANSTORACICO C</option>
            <option value="3"> ECOCARDIOGRAMAS TRANSESOFAGICOS SIN Y CON CONTRASTE</option>
            <option value="4"> ECOCARDIOGRAMAS TRANSTORACICOS</option>
            <option value="7"> ELECTROCARDIOGRAMAS B</option>
            <option value="8"> HOLTER ELECTROCARDIOGRAFO EKG</option>
            <option value="9"> MESA BASCULANTE</option>
            <option value="10">MESA BASCULANTE B</option>
            <option value="11">MONITOREO PRESIÓN ARTERIAL</option>
            <option value="12">PRUEBAS DE ESFUERZO</option>
        </select>
    </div>
    <br><br>
    <div class="calendar-container">
        <button id="prev-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div id="calendar"></div>
        <button id="next-btn"><i class="fa-solid fa-arrow-right"></i></button>
    </div>
    
    <div class="hour-selection">
        <h2>Selecciona una hora</h2>
        <table id="schedule-table" border="1" class="table_citas">
            <thead>
                <tr>
                    <th>Día y Fecha</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán aquí -->
            </tbody>
        </table>
    </div>

    <div class="form-container" style="display:none;">
        <h2>Formulario de Registro de Citas</h2>
        <form method="post" action="{{ url_for('main.reg_citas') }}">
            <div id="appointment-form">
                <div>
                    <h3>Detalles de la Cita</h3>
                    <label>Título de la cita</label><br><br>
                    <input type="text" id="title" name="title" readonly required><br>
                    <label>Descripción de la cita</label><br><br>
                    <input type="text" id="description" name="description" required><br>
                    <label>Fecha de inicio</label><br><br>
                    <input type="date" id="inicio-fecha" name="inicio_fecha" readonly required>
                    <input type="time" id="inicio-hora" name="inicio_hora" readonly required><br><br>
                    <label>Fecha de fin</label><br><br>
                    <input type="date" id="fin-fecha" name="fin_fecha" readonly required>
                    <input type="time" id="fin-hora" name="fin_hora" readonly required><br><br>
                    <label>Repetir</label><br><br>
                    <select name="repetir" class="selecc"  required>
                        <option value="no">No se repite</option>
                        <option value="diario">Diario</option>
                        <option value="semanal">Semanal</option>
                        <option value="mensual">Mensual</option>
                    </select><br>
                    <label>Recursos</label><br><br>
                    <select name="recursos" class="selecc"  required>
                        <option value="MESA BASCULANTE B">MESA BASCULANTE B</option>
                        <option value="Otro">Otro</option>
                    </select><br>
                </div>
                <div>
                    <h3>Información del Paciente</h3>
                    <label>Nombre o Rut(CC)</label><br><br>
                    <input type="text" name="paciente" class="selecc" required><br>
                    <table id="resultsTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Correo Electrónico</th>
                                <th>Rut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los resultados se mostrarán aquí -->
                        </tbody>
                    </table>
                    <label>Edad del paciente</label><br><br>
                    <input type="number" name="edad" required><br>
                    <label>Estado de la cita</label><br><br>
                    <select name="estado" class="selecc" required>
                        <option value="1">Reprogramada</option>
                        <option value="2">Asignada</option>
                        <option value="3">Cancelada</option>
                    </select><br>
                    <label>Número de autorización</label><br><br>
                    <input type="text" name="autorizacion" required><br>
                    <label>El paciente requiere prioridad de atención</label><br><br>
                    <select name="prioridad" class="selecc" required>
                        <option value="no">No</option>
                        <option value="si">Sí</option>
                    </select><br>
                    <label>Registro en la llamada</label><br><br>
                    <select name="registro_llamada" class="selecc" required>
                        <option value="N">N</option>
                        <option value="S">S</option>
                    </select><br>
                    <label>¿Cuál?</label><br><br>
                    <input type="text" name="cual" required><br>
                </div>
            </div>
            <input type="submit" value="Enviar">
        </form>
    </div>

    <script>
        $(document).ready(function(){
            $('#paciente').on('input', function(){
                let query = $(this).val();
                if(query.length > 2) {
                    $.ajax({
                        url: "{{ url_for('main.search_user') }}",
                        method: "GET",
                        data: { query: query },
                        success: function(data) {
                            let results = data.results;
                            let tableBody = $('#resultsTable tbody');
                            tableBody.empty();

                            if(results.length > 0) {
                                $('#resultsTable').show();
                                results.forEach(function(user) {
                                    let row = `<tr class="selectable">
                                        <td>${user.fname} ${user.lname}</td>
                                        <td>${user.email}</td>
                                        <td>${user.rut_cc}</td>
                                    </tr>`;
                                    tableBody.append(row);
                                });

                                $('.selectable').on('click', function() {
                                    let selectedText = $(this).find('td').eq(2).text(); // Assuming Rut(CC) is in the third column
                                    $('#paciente').val(selectedText);
                                    $('#resultsTable').hide();
                                });
                            } else {
                                $('#resultsTable').hide();
                            }
                        }
                    });
                } else {
                    $('#resultsTable').hide();
                }
            });
        });
    </script>

    <script>
        $(document).ready(function() {
    // Función para generar los intervalos de tiempo
    function generateTimeSlots(start, end, interval) {
        let slots = [];
        let startTime = new Date();
        startTime.setHours(start.split(':')[0], start.split(':')[1], 0, 0);
        let endTime = new Date();
        endTime.setHours(end.split(':')[0], end.split(':')[1], 0, 0);

        while (startTime < endTime) {
            let endTimeSlot = new Date(startTime.getTime() + interval * 60000);
            slots.push(`${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTimeSlot.getHours().toString().padStart(2, '0')}:${endTimeSlot.getMinutes().toString().padStart(2, '0')}`);
            startTime = endTimeSlot;
        }
        return slots;
    }

    // Función para generar la tabla de horarios
    function generateTable(startDate, interval) {
        let start = "07:00";
        let end = "17:00";
        let slots = generateTimeSlots(start, end, interval);

        let tableHead = `<tr><th>Día y Fecha</th>${slots.map(slot => `<th>${slot}</th>`).join('')}</tr>`;
        let tableBody = '';

        // Encuentra el lunes de la semana de la fecha seleccionada
        let dayOfWeek = startDate.getDay();
        let monday = new Date(startDate);
        monday.setDate(startDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));

        for (let i = 0; i < 7; i++) {
            let currentDay = new Date(monday);
            currentDay.setDate(monday.getDate() + i);

            let dayOfWeekStr = currentDay.toLocaleString('es-ES', { weekday: 'long' });
            let date = currentDay.toLocaleDateString('es-ES');

            tableBody += `<tr><td>${dayOfWeekStr}, ${date}</td>${slots.map(slot => `<td class="hour-column" data-date="${date}" data-time="${slot}"></td>`).join('')}</tr>`;
        }

        $('#schedule-table thead').html(tableHead);
        $('#schedule-table tbody').html(tableBody);

        // Adjuntar el evento de clic a las celdas de la columna de horas
        $('.hour-column').on('click', function() {
            const cita = $('.cita option:selected').text();
            let date = $(this).data('date');
            let time = $(this).data('time');
            let [start, end] = time.split(' - ');

            $('#title').val(`Cita - ${cita}`);
            $('#inicio-fecha').val(date);
            $('#inicio-hora').val(start);
            $('#fin-fecha').val(date);
            $('#fin-hora').val(end);

            // Mostrar el formulario y ocultar otros elementos
            $('#title, #inicio-fecha, #inicio-hora, #fin-fecha, #fin-hora').prop('readonly', true);
            $('.selecc').prop('readonly', true);
            $('.Info_cita').hide();
            $('.calendar-container').hide();
            $('.hour-selection').hide();
            $('.form-container').show();
        });
        
    }

    // Lógica para el calendario y la tabla al cargar la página
    const calendarContainer = document.getElementById('calendar');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    let selectedDate = new Date(); // Fecha actual predeterminada
    let currentYear = selectedDate.getFullYear();
    let currentMonth = selectedDate.getMonth();

    function getMonthsArray(year, startMonth) {
        return Array.from({ length: 3 }, (_, i) => new Date(year, startMonth + i));
    }


    function renderCalendar() {
        calendarContainer.innerHTML = '';
        const months = getMonthsArray(currentYear, currentMonth);
        months.forEach(date => {
            const monthDiv = document.createElement('div');
            monthDiv.className = 'month';

            const monthNameDiv = document.createElement('div');
            monthNameDiv.className = 'month-name';
            monthNameDiv.textContent = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
            monthDiv.appendChild(monthNameDiv);

            const weekdaysDiv = document.createElement('div');
            weekdaysDiv.className = 'weekdays';
            ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => {
                const weekdayDiv = document.createElement('div');
                weekdayDiv.className = 'weekday';
                weekdayDiv.textContent = day;
                weekdaysDiv.appendChild(weekdayDiv);
            });
            monthDiv.appendChild(weekdaysDiv);

            const daysDiv = document.createElement('div');
            daysDiv.className = 'days';
            const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay() || 7;
            const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

            for (let i = 1; i < firstDay; i++) {
                const emptyDiv = document.createElement('div');
                emptyDiv.className = 'day empty';
                daysDiv.appendChild(emptyDiv);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayDiv = document.createElement('div');
                dayDiv.className = 'day';
                dayDiv.textContent = day;
                dayDiv.addEventListener('click', () => {
                    selectedDate = new Date(date.getFullYear(), date.getMonth(), day);
                    $.getJSON("{{ url_for('main.get_time_interval') }}", function(data) {
                        generateTable(selectedDate, parseInt(data.interval));
                    });
                });
                daysDiv.appendChild(dayDiv);
            }

            monthDiv.appendChild(daysDiv);
            calendarContainer.appendChild(monthDiv);
        });
    }

    prevBtn.addEventListener('click', () => {
        currentMonth -= 3;
        if (currentMonth < 0) {
            currentMonth += 12;
            currentYear -= 1;
        }
        renderCalendar();
    });

    nextBtn.addEventListener('click', () => {
        currentMonth += 3;
        if (currentMonth > 11) {
            currentMonth -= 12;
            currentYear += 1;
        }
        renderCalendar();
    });

    renderCalendar();

    // Generar la tabla con la fecha actual al cargar la página
    $.getJSON("{{ url_for('main.get_time_interval') }}", function(data) {
        generateTable(selectedDate, parseInt(data.interval));
    });

});
$(document).ready(function() {
            $('.time-slot').on('click', function() {
                let selectedDate = $(this).data('date');
                $('#inicio-fecha').val(selectedDate);
                $('#fin-fecha').val(selectedDate);
                $('.form-container').show();
            });
        });

    </script>

    {% endblock %}
</body>
</html>
