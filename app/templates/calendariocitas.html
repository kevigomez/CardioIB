
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario y Registro de Citas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_calendario.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@5.11.2/main.min.js'></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    {% extends "base.html" %}
    {% block content %}
    <div>
    <div class="Info_cita">
        <select class="cita">
            <option value="2">Cardiologia B</option>
            <option value="1">Cardiologia B</option>
            <option value="21" selected="selected">Cardiologia C</option>
            <option value="22">ECOCARDIOGRAMA TRANSTORACICO C</option>
            <option value="3"> ECOCARDIOGRAMAS TRANSESOFAGICOS SIN Y CON CONTRASTE</option>
            <option value="4"> ECOCARDIOGRAMAS TRANSTORACICOS</option>
            <option value="7"> ELECTROCARDIOGRAMAS B</option>
            <option value="8"> HOLTER ELECTROCARDIOGRAFO EKG</option>
            <option value="9"> MESA BASCULANTE</option>
            <option value="10">MESA BASCULANTE B</option>
            <option value="11">MONITOREO PRESIÓN ARTERIAL</option>
            <option value="12">PRUEBAS DE ESFUERZO</option>
        </select>
    </div>
    <br><br>
    <div class="calendar-container">
        <button id="prev-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div id="calendar"></div>
        <button id="next-btn"><i class="fa-solid fa-arrow-right"></i></button>
    </div>
    
    <div class="hour-selection"><!--con este -->
        <h2>Selecciona una hora</h2>
        <table id="schedule-table" border="1" class="table_citas">
            <thead>
                <tr>
                    <th>Día y Fecha</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán aquí -->
            </tbody>
        </table>
    </div>

    <div class="form-container" style="display:none;">
        <h2>Formulario de Registro de Citas</h2>
        <form method="post" action="{{ url_for('main.reg_citas') }}">
            <div id="appointment-form">
                <div>
                    <h3>Detalles de la Cita</h3>
                    <label>Título de la cita</label><br><br>
                    <input type="text" id="title" name="title" readonly required><br>
                    <label>Descripción de la cita</label><br><br>
                    <input type="text" id="description" name="description" required><br>
                    <label>Fecha de inicio</label><br><br>
                    <input type="date" id="inicio-fecha" name="inicio_fecha" readonly required>
                    <input type="time" id="inicio-hora" name="inicio_hora" required><br><br>
                    <label>Fecha de fin</label><br><br>
                    <input type="date" id="fin-fecha" name="fin_fecha" readonly required>
                    <input type="time" id="fin-hora" name="fin_hora" required>
                    <p id="duracion">0 horas 0 minutos</p>                    
                    <label>Repetir</label><br><br>
                    <select name="repetir" class="selecc"  required>
                        <option value="no">No se repite</option>
                        <option value="diario">Diario</option>
                        <option value="semanal">Semanal</option>
                        <option value="mensual">Mensual</option>
                    </select><br>
                    <label>Recursos</label><br><br>
                    <select name="recursos" class="selecc"  required>
                        <option value="MESA BASCULANTE B">MESA BASCULANTE B</option>
                        <option value="Otro">Otro</option>
                    </select><br>
                </div>
                <div>
                    <h3>Información del Paciente</h3>
                    <label>Nombre o Rut(CC)</label><br><br>
                    <input type="text" id="paciente" name="paciente" required><br>
                    <table id="resultsTable" style="display:none;">
                        <tbody>
                            <!-- Los resultados se mostrarán aquí -->
                        </tbody>
                    </table>
                    <label>Edad del paciente</label><br><br>
                    <input type="number" name="edad" min="18" max="100" required><br>
                    <label>Estado de la cita</label><br><br>
                    <select name="estado" class="selecc" required>
                        <option value="1">Reprogramada</option>
                        <option value="2">Asignada</option>
                        <option value="3">Cancelada</option>
                    </select><br>
                    <label>Número de autorización</label><br><br>
                    <input type="text" name="autorizacion" required><br>
                    <label>El paciente requiere prioridad de atención</label><br><br>
                    <select name="prioridad" class="selecc" required>
                        <option value="no">No</option>
                        <option value="si">Sí</option>
                    </select><br>
                    <label>Registro en la llamada</label><br><br>
                    <select name="registro_llamada" class="selecc" required>
                        <option value="N">N</option>
                        <option value="S">S</option>
                    </select><br>
                    <label>¿Cuál?</label><br><br>
                    <input type="text" name="cual" required><br>
                </div>
            </div>
            <input type="submit" value="Enviar">
        </form>
    </div>
            <script>
                document.addEventListener('DOMContentLoaded', function () {
                    var calendarEl = document.getElementById('calendar');
                    var scheduleTableEl = document.getElementById('schedule-table');

                    var calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'es',
                        events: function (fetchInfo, successCallback, failureCallback) {
                            fetch('/get_appointments')
                                .then(response => response.json())
                                .then(data => {
                                    successCallback(data.appointments);
                                })
                                .catch(error => {
                                    console.error('Error fetching appointments:', error);
                                    failureCallback(error);
                                });
                        }
                    });

                    calendar.render();
                });
    

    </script>
    

    <script>
        $(document).ready(function() {
            $(document).ready(function() {
                function loadAppointments() {
                $.ajax({
                    url: "{{ url_for('main.get_appointments') }}",
                    method: "GET",
                    success: function(response) {
                        let appointments = response.appointments;
                        console.log('Citas:', appointments);

                        appointments.forEach(appointment => {
                            let startDate = new Date(appointment.start);
                            let endDate = new Date(appointment.end);
                            let dateString = `${startDate.getFullYear()}-${String(startDate.getMonth() + 1).padStart(2, '0')}-${String(startDate.getDate()).padStart(2, '0')}`;
                            let timeSlot = `${String(startDate.getHours()).padStart(2, '0')}:${String(startDate.getMinutes()).padStart(2, '0')} - ${String(endDate.getHours()).padStart(2, '0')}:${String(endDate.getMinutes()).padStart(2, '0')}`;

                            // Aquí podrías querer ajustar cómo se identifican las celdas en el calendario
                            $(`#schedule-table td[data-date="${dateString}"][data-time="${timeSlot}"]`)
                                .addClass('has-appointment')
                                .attr('title', appointment.title);
                        });
                    },
                    error: function(error) {
                        console.log('Error al obtener las citas:', error);
                    }
                });
            }

                loadAppointments(); // Llama a esta función para cargar las citas
            });
    
            $('#paciente').on('input', function() {
                let query = $(this).val();
                if (query.length > 2) {
                    $.ajax({
                        url: "{{ url_for('main.search_user') }}",
                        method: "GET",
                        data: { query: query },
                        success: function(data) {
                            let results = data.results;
                            let tableBody = $('#resultsTable tbody');
                            tableBody.empty();
    
                            if (results.length > 0) {
                                $('#resultsTable').show();
                                results.forEach(function(user) {
                                    let row = `<tr class="selectable">
                                        <td>${user.fname} ${user.lname} (${user.organization})</td>
                                    </tr>`;
                                    tableBody.append(row);
                                });
    
                                $('.selectable').on('click', function() {
                                    let selectedText = $(this).find('td').text();
                                    $('#paciente').val(selectedText);
                                    $('#resultsTable').hide();
                                });
                            } else {
                                $('#resultsTable').hide();
                            }
                        },
                        error: function(error) {
                            console.log('Error:', error);
                        }
                    });
                } else {
                    $('#resultsTable').hide();
                }
            });
    
            $('#citaForm').on('submit', function(event) {
                event.preventDefault(); // Evitar el envío del formulario estándar
                let formData = $(this).serialize(); // Obtener todos los datos del formulario
    
                $.ajax({
                    url: "{{ url_for('main.reg_citas') }}",
                    method: "POST",
                    data: formData,
                    success: function(response) {
                        console.log('Formulario enviado exitosamente', response);
                        // Puedes agregar lógica adicional aquí, como mostrar un mensaje de éxito
                    },
                    error: function(error) {
                        console.log('Error al enviar el formulario', error);
                        // Puedes agregar lógica adicional aquí, como mostrar un mensaje de error
                    }
                });
            });
    
            function generateTable(startDate, interval) {
                let start = "07:00";
                let end = "17:00";
                let slots = generateTimeSlots(start, end, interval);
    
                let tableHead = `<tr><th>Día y Fecha</th>${slots.map(slot => `<th>${slot}</th>`).join('')}</tr>`;
                let tableBody = '';
    
                let dayOfWeek = startDate.getDay();
                let monday = new Date(startDate);
                monday.setDate(startDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
    
                for (let i = 0; i < 7; i++) {
                    let currentDay = new Date(monday);
                    currentDay.setDate(monday.getDate() + i);
    
                    let dayOfWeekStr = currentDay.toLocaleString('es-ES', { weekday: 'long' });
                    let date = currentDay.toLocaleDateString('es-ES');
    
                    tableBody += `<tr><td>${dayOfWeekStr}, ${date}</td>${slots.map(slot => `<td class="hour-column" data-date="${currentDay}" data-time="${slot}"></td>`).join('')}</tr>`;
                }
    
                $('#schedule-table thead').html(tableHead);
                $('#schedule-table tbody').html(tableBody);
    
                $('.hour-column').on('click', function() {
                    const cita = $('.cita option:selected').text();
                    let date = new Date($(this).data('date'));
                    let time = $(this).data('time');
                    let [start, end] = time.split(' - ');
    
                    let duracion = calculateDuration(start, end);
                    $('#duracion').text(duracion);
                    console.log('Celda clickeada:', date, time);
                    $('#title').val(`Cita - ${cita}`);
                    $('#inicio-fecha').val(formatDate(date));
                    $('#inicio-hora').val(formatTime(start));
                    $('#fin-fecha').val(formatDate(date));
                    $('#fin-hora').val(formatTime(end));
    
                    $('#title, #inicio-fecha, #fin-fecha').prop('readonly', true);
                    $('.selecc').prop('readonly', true);
                    $('.Info_cita').hide();
                    $('.calendar-container').hide();
                    $('.hour-selection').hide();
                    $('.form-container').show();
                });
                loadAppointments();
            }
            function formatDate(date) {
                let day = String(date.getDate()).padStart(2, '0');
                let month = String(date.getMonth() + 1).padStart(2, '0');
                let year = date.getFullYear();
                return `${year}-${month}-${day}`;
            }
    
            function formatTime(time) {
                let [hours, minutes] = time.split(':');
                return `${hours.padStart(2, '0')}:${minutes.padStart(2, '0')}`;
            }
    
            function calculateDuration(start, end) {
                let startTime = new Date(`1970-01-01T${start}:00`);
                let endTime = new Date(`1970-01-01T${end}:00`);
                let duration = (endTime - startTime) / 60000; // duración en minutos
                let hours = Math.floor(duration / 60);
                let minutes = duration % 60;
                return `${hours} horas ${minutes} minutos`;
            }
    
            function generateTimeSlots(start, end, interval) {
                let slots = [];
                let startTime = new Date();
                startTime.setHours(start.split(':')[0], start.split(':')[1], 0, 0);
                let endTime = new Date();
                endTime.setHours(end.split(':')[0], end.split(':')[1], 0, 0);
    
                while (startTime < endTime) {
                    let endTimeSlot = new Date(startTime.getTime() + interval * 60000);
                    slots.push(`${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTimeSlot.getHours().toString().padStart(2, '0')}:${endTimeSlot.getMinutes().toString().padStart(2, '0')}`);
                    startTime = endTimeSlot;
                }
                return slots;
            }
    
    
            const calendarContainer = document.getElementById('calendar');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            let selectedDate = new Date();
            let currentYear = selectedDate.getFullYear();
            let currentMonth = selectedDate.getMonth();
    
            function getMonthsArray(year, startMonth) {
                return Array.from({ length: 3 }, (_, i) => new Date(year, startMonth + i));
            }
    
            function renderCalendar() {
                calendarContainer.innerHTML = '';
                const months = getMonthsArray(currentYear, currentMonth);
                months.forEach(date => {
                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'month';
    
                    const monthNameDiv = document.createElement('div');
                    monthNameDiv.className = 'month-name';
                    monthNameDiv.textContent = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                    monthDiv.appendChild(monthNameDiv);
    
                    const weekdaysDiv = document.createElement('div');
                    weekdaysDiv.className = 'weekdays';
                    ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => {
                        const weekdayDiv = document.createElement('div');
                        weekdayDiv.className = 'weekday';
                        weekdayDiv.textContent = day;
                        weekdaysDiv.appendChild(weekdayDiv);
                    });
                    monthDiv.appendChild(weekdaysDiv);
    
                    const daysDiv = document.createElement('div');
                    daysDiv.className = 'days';
                    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay() || 7;
                    const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
    
                    for (let i = 1; i < firstDay; i++) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'day empty';
                        daysDiv.appendChild(emptyDiv);
                    }
    
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'day';
                        dayDiv.textContent = day;
                        dayDiv.addEventListener('click', () => {
                            selectedDate = new Date(date.getFullYear(), date.getMonth(), day);
                            $.getJSON("{{ url_for('main.get_time_interval') }}", function(data) {
                                generateTable(selectedDate, parseInt(data.interval));
                                loadAppointments(); // Cambiado a loadAppointments
                            });
                        });
                        daysDiv.appendChild(dayDiv);
                    }
    
                    monthDiv.appendChild(daysDiv);
                    calendarContainer.appendChild(monthDiv);
                });
            }
    
            prevBtn.addEventListener('click', () => {
                currentMonth -= 3;
                if (currentMonth < 0) {
                    currentMonth += 12;
                    currentYear -= 1;
                }
                renderCalendar();
            });
    
            nextBtn.addEventListener('click', () => {
                currentMonth += 3;
                if (currentMonth > 11) {
                    currentMonth -= 12;
                    currentYear += 1;
                }
                renderCalendar();
            });
    
            renderCalendar(); 
    
            $.getJSON("{{ url_for('main.get_time_interval') }}", function(data) {
                generateTable(selectedDate, parseInt(data.interval));
                loadAppointments(); // Cambiado a loadAppointments
            });
        });
    </script>
    
    </div>
    {% endblock %}
</body>
</html> 