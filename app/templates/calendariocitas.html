<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario y Registro de Citas</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles_calendario.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="{{ url_for('static', filename='script/script.js') }}" defer></script>
</head>
<body>
    {% extends "base.html" %}
    {% block content %}
    <div class="Info_cita">
        <select class="cita">
            <option value="2"  id="cita" >Cardiologia B</option>
            <option value="1"  id="cita" >Cardiologia B</option>
            <option value="21" id="cita"  selected="selected">Cardiologia C</option>
            <option value="22" id="cita" >ECOCARDIOGRAMA TRANSTORACICO C</option>
            <option value="3"  id="cita" > ECOCARDIOGRAMAS TRANSESOFAGICOS SIN Y CON CONTRASTE</option>
            <option value="4"  id="cita" > ECOCARDIOGRAMAS TRANSTORACICOS</option>
            <option value="7"  id="cita" > ELECTROCARDIOGRAMAS B</option>
            <option value="8"  id="cita" > HOLTER ELECTROCARDIOGRAFO EKG</option>
            <option value="9"  id="cita" > MESA BASCULANTE</option>
            <option value="10" id="cita" >MESA BASCULANTE B</option>
            <option value="11" id="cita" >MONITOREO PRESIÓN ARTERIAL</option>
            <option value="12" id="cita" >PRUEBAS DE ESFUERZO</option>
        </select>
    </div>
    <br><br>
    <div class="calendar-container">
        <button id="prev-btn"><i class="fa-solid fa-arrow-left"></i></button>
        <div id="calendar"></div>
        <button id="next-btn"><i class="fa-solid fa-arrow-right"></i></button>
    </div>
    
    <div class="hour-selection">
        <h2>Selecciona una hora</h2>
        <table id="schedule-table" border="1" class="table_citas">
            <thead>
                <tr>
                    <th>Día</th>
                </tr>
            </thead>
            <tbody>
                <!-- Las filas se generarán aquí -->
            </tbody>
        </table>
    </div>

    <div class="form-container" style="display:none;">
        <h2>Formulario de Registro de Citas</h2>
        <form method="post" action="{{ url_for('main.reg_citas') }}">
            <div id="appointment-form">
                <div>
                    <h3>Detalles de la Cita</h3>
                    <label>Título de la cita</label><br><br>
                    <input type="text" id="title" name="title" readonly required><br>
                    <label>Descripción de la cita</label><br><br>
                    <input type="text" id="description" name="description" readonly required><br>
                    <label>Fecha de inicio</label><br><br>
                    <input type="date" id="inicio-fecha" name="inicio_fecha" readonly required>
                    <input type="time" id="inicio-hora" name="inicio_hora" readonly required><br><br>
                    <label>Fecha de fin</label><br><br>
                    <input type="date" id="fin-fecha" name="fin_fecha" readonly required>
                    <input type="time" id="fin-hora" name="fin_hora" readonly required><br><br>
                    <label>Repetir</label><br><br>
                    <select name="repetir" class="selecc" readonly required>
                        <option value="no">No se repite</option>
                        <option value="diario">Diario</option>
                        <option value="semanal">Semanal</option>
                        <option value="mensual">Mensual</option>
                    </select><br>
                    <label>Recursos</label><br><br>
                    <select name="recursos" class="selecc" readonly required>
                        <option value="MESA BASCULANTE B">MESA BASCULANTE B</option>
                        <option value="Otro">Otro</option>
                    </select><br>
                </div>
                <div>
                    <h3>Información del Paciente</h3>
                    <label>Nombre o Rut(CC)</label><br><br>
                    <input type="text" name="paciente" class="selecc" required><br>
                    <table id="resultsTable" style="display:none;">
                        <thead>
                            <tr>
                                <th>Nombre</th>
                                <th>Correo Electrónico</th>
                                <th>Rut</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Los resultados se mostrarán aquí -->
                        </tbody>
                    </table>
                    <label>Edad del paciente</label><br><br>
                    <input type="number" name="edad" required><br>
                    <label>Estado de la cita</label><br><br>
                    <select name="estado" class="selecc" required>
                        <option value="1">Reprogramada</option>
                        <option value="2">Asignada</option>
                        <option value="3">Cancelada</option>
                    </select><br>
                    <label>Número de autorización</label><br><br>
                    <input type="text" name="autorizacion" required><br>
                    <label>El paciente requiere prioridad de atención</label><br><br>
                    <select name="prioridad" class="selecc" required>
                        <option value="no">No</option>
                        <option value="si">Sí</option>
                    </select><br>
                    <label>Registro en la llamada</label><br><br>
                    <select name="registro_llamada" class="selecc" required>
                        <option value="N">N</option>
                        <option value="S">S</option>
                    </select><br>
                    <label>¿Cuál?</label><br><br>
                    <input type="text" name="cual" required><br>
                </div>
            </div>
            <input type="submit" value="Enviar">
        </form>
    </div>

    <script>
        $(document).ready(function(){
            $('#paciente').on('input', function(){
                let query = $(this).val();
                if(query.length > 2) {
                    $.ajax({
                        url: "{{ url_for('main.search_user') }}",
                        method: "GET",
                        data: { query: query },
                        success: function(data) {
                            let results = data.results;
                            let tableBody = $('#resultsTable tbody');
                            tableBody.empty();

                            if(results.length > 0) {
                                $('#resultsTable').show();
                                results.forEach(function(user) {
                                    let row = `<tr class="selectable">
                                        <td>${user.fname} ${user.lname}</td>
                                        <td>${user.email}</td>
                                        <td>${user.rut_cc}</td>
                                    </tr>`;
                                    tableBody.append(row);
                                });

                                $('.selectable').on('click', function() {
                                    let selectedText = $(this).find('td').eq(2).text(); // Assuming Rut(CC) is in the third column
                                    $('#paciente').val(selectedText);
                                    $('#resultsTable').hide();
                                });
                            } else {
                                $('#resultsTable').hide();
                            }
                        }
                    });
                } else {
                    $('#resultsTable').hide();
                }
            });
        });
    </script>

    <script>
        $(document).ready(function() {
            function generateTimeSlots(start, end, interval) {
                let slots = [];
                let startTime = new Date();
                startTime.setHours(start.split(':')[0], start.split(':')[1], 0, 0);
                let endTime = new Date();
                endTime.setHours(end.split(':')[0], end.split(':')[1], 0, 0);

                while (startTime < endTime) {
                    let endTimeSlot = new Date(startTime.getTime() + interval * 60000);
                    slots.push(`${startTime.getHours().toString().padStart(2, '0')}:${startTime.getMinutes().toString().padStart(2, '0')} - ${endTimeSlot.getHours().toString().padStart(2, '0')}:${endTimeSlot.getMinutes().toString().padStart(2, '0')}`);
                    startTime = endTimeSlot;
                }
                return slots;
            }

            function generateTable(interval) {
                let start = "07:00";
                let end = "17:00";
                let slots = generateTimeSlots(start, end, interval);
                let days = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes"];

                let tableHead = `<tr><th>Día</th>${slots.map(slot => `<th>${slot}</th>`).join('')}</tr>`;
                let tableBody = days.map(day => `<tr><td>${day}</td>${slots.map(slot => `<td class="hour-column" data-day="${day}" data-time="${slot}"></td>`).join('')}</tr>`).join('');

                $('#schedule-table thead').html(tableHead);
                $('#schedule-table tbody').html(tableBody);
            }

            // Obtener el intervalo de tiempo desde el servidor y generar la tabla
            $.getJSON("{{ url_for('main.get_time_interval') }}", function(data) {
                generateTable(parseInt(data.interval));

                // Adjuntar el evento de clic a las celdas de la columna de horas
                $('.hour-column').on('click', function() {
                    const cita = document.getElementById('cita');
                    let time = $(this).data('time');
                    let [start, end] = time.split(' - ');

                    $('#title').val(`Cita - ${cita}`);
                    $('#description').val(`Cita el ${cita} a las ${start}`);
                    $('#inicio-fecha').val(selectedDate);
                    $('#inicio-hora').val(start);
                    $('#fin-fecha').val(selectedDate);
                    $('#fin-hora').val(end);

                    $('#title, #description, #inicio-fecha, #inicio-hora, #fin-fecha, #fin-hora').prop('readonly', true);
                    $('.selecc').prop('readonly', true);

                    $('.form-container').show();
                });
            });

            const calendarContainer = document.getElementById('calendar');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            let selectedDate;
            let currentYear = new Date().getFullYear();
            let currentMonth = new Date().getMonth();

            function getMonthsArray(year, startMonth) {
                return Array.from({ length: 3 }, (_, i) => new Date(year, startMonth + i));
            }

            function renderCalendar() {
                calendarContainer.innerHTML = '';
                const months = getMonthsArray(currentYear, currentMonth);
                months.forEach(date => {
                    const monthDiv = document.createElement('div');
                    monthDiv.className = 'month';

                    const monthNameDiv = document.createElement('div');
                    monthNameDiv.className = 'month-name';
                    monthNameDiv.textContent = date.toLocaleString('es-ES', { month: 'long', year: 'numeric' });
                    monthDiv.appendChild(monthNameDiv);

                    const weekdaysDiv = document.createElement('div');
                    weekdaysDiv.className = 'weekdays';
                    ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'].forEach(day => {
                        const weekdayDiv = document.createElement('div');
                        weekdayDiv.className = 'weekday';
                        weekdayDiv.textContent = day;
                        weekdaysDiv.appendChild(weekdayDiv);
                    });
                    monthDiv.appendChild(weekdaysDiv);

                    const daysDiv = document.createElement('div');
                    daysDiv.className = 'days';
                    const firstDay = new Date(date.getFullYear(), date.getMonth(), 1).getDay() || 7;
                    const daysInMonth = new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();

                    for (let i = 1; i < firstDay; i++) {
                        const emptyDiv = document.createElement('div');
                        emptyDiv.className = 'day empty';
                        daysDiv.appendChild(emptyDiv);
                    }

                    for (let day = 1; day <= daysInMonth; day++) {
                        const dayDiv = document.createElement('div');
                        dayDiv.className = 'day';
                        dayDiv.textContent = day;
                        dayDiv.addEventListener('click', () => {
                            selectedDate = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                            $('.calendar-container').hide();
                            $('.hour-selection').show();
                        });
                        daysDiv.appendChild(dayDiv);
                    }

                    monthDiv.appendChild(daysDiv);
                    calendarContainer.appendChild(monthDiv);
                });
            }

            prevBtn.addEventListener('click', () => {
                currentMonth -= 3;
                if (currentMonth < 0) {
                    currentMonth += 12;
                    currentYear -= 1;
                }
                renderCalendar();
            });

            nextBtn.addEventListener('click', () => {
                currentMonth += 3;
                if (currentMonth > 11) {
                    currentMonth -= 12;
                    currentYear += 1;
                }
                renderCalendar();
            });

            renderCalendar();

            $('#appointment-form').submit(function(event) {
                event.preventDefault();
                alert('Cita registrada con éxito');
                // Aquí puedes agregar la lógica para enviar el formulario al servidor
            });
        });
    </script>

    {% endblock %}
</body>
</html>
